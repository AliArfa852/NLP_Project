<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multilingual Emotion Chatbot</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        body {
            background-color: #f8f9fa;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .chat-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .chat-header {
            background-color: #563d7c;
            color: white;
            padding: 15px;
            border-radius: 10px 10px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .chat-messages {
            height: 500px;
            overflow-y: auto;
            padding: 15px;
            background-color: white;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
        }
        .chat-input {
            padding: 15px;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 0 0 10px 10px;
        }
        .message {
            margin-bottom: 15px;
            padding: 10px 15px;
            border-radius: 5px;
            max-width: 80%;
            position: relative;
        }
        .user-message {
            background-color: #dcf8c6;
            margin-left: auto;
            margin-right: 10px;
            text-align: right;
        }
        .bot-message {
            background-color: #f1f0f0;
            margin-right: auto;
            margin-left: 10px;
        }
        .emotion-tag {
            font-size: 0.8em;
            margin-right: 5px;
            padding: 2px 8px;
            border-radius: 10px;
            display: inline-block;
        }
        .emotion-happy {
            background-color: #FFD700;
            color: #000;
        }
        .emotion-sad {
            background-color: #6495ED;
            color: white;
        }
        .emotion-angry {
            background-color: #FF6347;
            color: white;
        }
        .emotion-neutral {
            background-color: #A9A9A9;
            color: white;
        }
        .settings-panel {
            background-color: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        .personality-description {
            font-size: 0.9em;
            font-style: italic;
            color: #6c757d;
            margin-top: 5px;
        }
        .bot-info {
            font-size: 0.8em;
            color: #6c757d;
            margin-top: 5px;
            display: flex;
            justify-content: space-between;
        }
        .tab-content {
            padding: 15px;
            background-color: white;
            border-left: 1px solid #dee2e6;
            border-right: 1px solid #dee2e6;
            border-bottom: 1px solid #dee2e6;
            border-radius: 0 0 10px 10px;
        }
        .stats-item {
            margin-bottom: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
        }
        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .message {
            animation: fadeIn 0.3s ease-out;
        }
        .typing-indicator {
            display: flex;
            align-items: center;
            margin-left: 20px;
            margin-bottom: 15px;
        }
        .typing-indicator span {
            height: 8px;
            width: 8px;
            background-color: #6c757d;
            border-radius: 50%;
            display: inline-block;
            margin-right: 3px;
            animation: bounce 1.5s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }
        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }
        @keyframes bounce {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-5px); }
        }
    </style>
</head>
<body>
    <div class="container chat-container">
        <div class="row">
            <div class="col-md-8">
                <div class="chat-header">
                    <h2>Multilingual Emotion Chatbot</h2>
                    <button id="settingsToggle" class="btn btn-sm btn-light"><i class="bi bi-gear"></i> Settings</button>
                </div>
                <div id="settingsPanel" class="settings-panel" style="display: none;">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="languageSelect" class="form-label">Language:</label>
                                <select id="languageSelect" class="form-select">
                                    {% for lang in languages %}
                                    <option value="{{ lang }}" {% if lang == default_language %}selected{% endif %}>
                                        {{ language_names[lang] }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="personalitySelect" class="form-label">Personality:</label>
                                <select id="personalitySelect" class="form-select">
                                    {% for personality in personalities %}
                                    <option value="{{ personality.id }}" {% if personality.id == default_personality %}selected{% endif %}>
                                        {{ personality.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <div id="personalityDescription" class="personality-description">
                                    {{ personalities[0].description }}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="rlToggle" {% if rl_enabled %}checked{% endif %}>
                                <label class="form-check-label" for="rlToggle">Enable Learning</label>
                            </div>
                        </div>
                        <div class="col-md-6 text-end">
                            <button id="clearChatBtn" class="btn btn-outline-danger"><i class="bi bi-trash"></i> Clear Chat</button>
                        </div>
                    </div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="bot-message message">
                        Hello! I'm your multilingual emotion chatbot. How are you feeling today?
                        <div class="bot-info">
                            <span id="botPersonality">Default Assistant</span>
                            <span id="botLanguage">English</span>
                        </div>
                    </div>
                </div>
                <div class="chat-input">
                    <div class="input-group">
                        <input type="text" id="userInput" class="form-control" placeholder="Type a message...">
                        <button id="sendButton" class="btn btn-primary">
                            <i class="bi bi-send"></i> Send
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <ul class="nav nav-tabs" id="infoTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="emotions-tab" data-bs-toggle="tab" data-bs-target="#emotions" 
                                type="button" role="tab" aria-controls="emotions" aria-selected="true">
                            Emotions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="stats-tab" data-bs-toggle="tab" data-bs-target="#stats" 
                                type="button" role="tab" aria-controls="stats" aria-selected="false">
                            Learning Stats
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="help-tab" data-bs-toggle="tab" data-bs-target="#help" 
                                type="button" role="tab" aria-controls="help" aria-selected="false">
                            Help
                        </button>
                    </li>
                </ul>
                <div class="tab-content" id="infoTabContent">
                    <div class="tab-pane fade show active" id="emotions" role="tabpanel" aria-labelledby="emotions-tab">
                        <h4>Emotion Detection</h4>
                        <p>The chatbot detects emotions in your messages:</p>
                        <div class="emotion-examples">
                            <span class="emotion-tag emotion-happy">Happy</span>
                            <span class="emotion-tag emotion-sad">Sad</span>
                            <span class="emotion-tag emotion-angry">Angry</span>
                            <span class="emotion-tag emotion-neutral">Neutral</span>
                        </div>
                        <div class="mt-3">
                            <h5>Recent Emotions</h5>
                            <div id="recentEmotions">
                                <p>No emotions detected yet.</p>
                            </div>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="stats" role="tabpanel" aria-labelledby="stats-tab">
                        <h4>Learning Statistics</h4>
                        <p>The chatbot learns from your interactions:</p>
                        <div id="learningStats">
                            <div class="d-flex justify-content-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                            </div>
                        </div>
                        <button id="refreshStatsBtn" class="btn btn-outline-primary mt-3">
                            <i class="bi bi-arrow-clockwise"></i> Refresh
                        </button>
                        <button id="resetLearningBtn" class="btn btn-outline-danger mt-3 float-end">
                            <i class="bi bi-trash"></i> Reset Learning
                        </button>
                    </div>
                    <div class="tab-pane fade" id="help" role="tabpanel" aria-labelledby="help-tab">
                        <h4>How to Use</h4>
                        <ul>
                            <li><strong>Language:</strong> Change the language in Settings.</li>
                            <li><strong>Personality:</strong> Try different chatbot personalities.</li>
                            <li><strong>Learning:</strong> The chatbot improves its responses through reinforcement learning.</li>
                            <li><strong>Emotions:</strong> Express different emotions and see how the chatbot responds.</li>
                        </ul>
                        <h5>Available Personalities:</h5>
                        <ul>
                            {% for personality in personalities %}
                            <li><strong>{{ personality.name }}:</strong> {{ personality.description }}</li>
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM elements
            const chatMessages = document.getElementById('chatMessages');
            const userInput = document.getElementById('userInput');
            const sendButton = document.getElementById('sendButton');
            const languageSelect = document.getElementById('languageSelect');
            const personalitySelect = document.getElementById('personalitySelect');
            const personalityDescription = document.getElementById('personalityDescription');
            const botPersonality = document.getElementById('botPersonality');
            const botLanguage = document.getElementById('botLanguage');
            const settingsToggle = document.getElementById('settingsToggle');
            const settingsPanel = document.getElementById('settingsPanel');
            const rlToggle = document.getElementById('rlToggle');
            const clearChatBtn = document.getElementById('clearChatBtn');
            const recentEmotions = document.getElementById('recentEmotions');
            const learningStats = document.getElementById('learningStats');
            const refreshStatsBtn = document.getElementById('refreshStatsBtn');
            const resetLearningBtn = document.getElementById('resetLearningBtn');
            
            // Initialize
            const personalities = JSON.parse('{{ personalities|tojson }}');
            let isTyping = false;
            
            // Update personality description when selection changes
            personalitySelect.addEventListener('change', function() {
                const selectedPersonality = personalities.find(p => p.id === this.value);
                if (selectedPersonality) {
                    personalityDescription.textContent = selectedPersonality.description;
                }
            });
            
            // Toggle settings panel
            settingsToggle.addEventListener('click', function() {
                settingsPanel.style.display = settingsPanel.style.display === 'none' ? 'block' : 'none';
            });
            
            // Send message when Enter key is pressed
            userInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            
            // Send message when Send button is clicked
            sendButton.addEventListener('click', sendMessage);
            
            // Clear chat
            clearChatBtn.addEventListener('click', clearChat);
            
            // Refresh stats
            refreshStatsBtn.addEventListener('click', loadLearningStats);
            
            // Reset learning
            resetLearningBtn.addEventListener('click', resetLearning);
            
            // Load initial stats
            loadLearningStats();
            
            function sendMessage() {
                const message = userInput.value.trim();
                if (message === '') return;
                
                // Disable input while processing
                userInput.disabled = true;
                sendButton.disabled = true;
                
                // Add user message to chat
                addMessageToChat(message, 'user-message');
                
                // Clear input
                userInput.value = '';
                
                // Show typing indicator
                showTypingIndicator();
                
                // Send message to server
                fetch('/send_message', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        language: languageSelect.value,
                        personality: personalitySelect.value,
                        use_rl: rlToggle.checked
                    }),
                })
                .then(response => response.json())
                .then(data => {
                    // Remove typing indicator
                    hideTypingIndicator();
                    
                    // Add bot message to chat
                    addMessageToChat(data.response, 'bot-message', data.emotions, data.personality_name, data.language);
                    
                    // Update emotions display
                    updateRecentEmotions(data.emotions);
                    
                    // Enable input
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    userInput.focus();
                })
                .catch(error => {
                    console.error('Error:', error);
                    hideTypingIndicator();
                    userInput.disabled = false;
                    sendButton.disabled = false;
                    
                    // Add error message
                    addMessageToChat('Sorry, there was an error processing your message. Please try again.', 'bot-message');
                });
            }
            
            function addMessageToChat(message, messageClass, emotions = [], personality = null, language = null) {
                const messageElement = document.createElement('div');
                messageElement.classList.add('message', messageClass);
                messageElement.textContent = message;
                
                // Add emotions for bot messages
                if (messageClass === 'bot-message' && emotions.length > 0) {
                    const infoDiv = document.createElement('div');
                    infoDiv.classList.add('bot-info');
                    
                    if (personality) {
                        const personalitySpan = document.createElement('span');
                        personalitySpan.textContent = personality;
                        infoDiv.appendChild(personalitySpan);
                        
                        // Update the displayed personality
                        botPersonality.textContent = personality;
                    }
                    
                    if (language) {
                        const languageSpan = document.createElement('span');
                        languageSpan.textContent = language.charAt(0).toUpperCase() + language.slice(1);
                        infoDiv.appendChild(languageSpan);
                        
                        // Update the displayed language
                        botLanguage.textContent = language.charAt(0).toUpperCase() + language.slice(1);
                    }
                    
                    messageElement.appendChild(infoDiv);
                }
                
                chatMessages.appendChild(messageElement);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function showTypingIndicator() {
                if (isTyping) return;
                
                isTyping = true;
                const typingIndicator = document.createElement('div');
                typingIndicator.classList.add('typing-indicator');
                typingIndicator.id = 'typingIndicator';
                
                for (let i = 0; i < 3; i++) {
                    const dot = document.createElement('span');
                    typingIndicator.appendChild(dot);
                }
                
                chatMessages.appendChild(typingIndicator);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
            
            function hideTypingIndicator() {
                const typingIndicator = document.getElementById('typingIndicator');
                if (typingIndicator) {
                    typingIndicator.remove();
                }
                isTyping = false;
            }
            
            function updateRecentEmotions(emotions) {
                if (!emotions || emotions.length === 0) return;
                
                const emotionsHtml = emotions.map(emotion => {
                    return `<span class="emotion-tag emotion-${emotion.toLowerCase()}">${emotion}</span>`;
                }).join(' ');
                
                // Add emotion to recent emotions panel with timestamp
                const timestamp = new Date().toLocaleTimeString();
                const emotionEntry = document.createElement('div');
                emotionEntry.classList.add('stats-item');
                emotionEntry.innerHTML = `
                    <div>${timestamp}</div>
                    <div>${emotionsHtml}</div>
                `;
                
                // Remove "No emotions detected yet" message if present
                if (recentEmotions.querySelector('p')) {
                    recentEmotions.innerHTML = '';
                }
                
                // Add the new emotion at the top
                recentEmotions.insertBefore(emotionEntry, recentEmotions.firstChild);
                
                // Limit to last 5 emotions
                const emotionEntries = recentEmotions.querySelectorAll('.stats-item');
                if (emotionEntries.length > 5) {
                    recentEmotions.removeChild(emotionEntries[emotionEntries.length - 1]);
                }
            }
            
            function loadLearningStats() {
                fetch('/get_learning_stats')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const stats = data.stats;
                        let statsHtml = `
                            <div class="stats-item">
                                <strong>Total Interactions:</strong> ${stats.total_interactions}
                            </div>
                            <div class="stats-item">
                                <strong>Average Reward:</strong> ${stats.average_reward}
                            </div>
                            <div class="stats-item">
                                <strong>Patterns Learned:</strong> ${stats.patterns_learned}
                            </div>
                            <div class="stats-item">
                                <strong>Success Rate:</strong> ${stats.success_rate}%
                            </div>
                        `;
                        
                        if (stats.top_transitions && stats.top_transitions.length > 0) {
                            statsHtml += `<div class="stats-item"><strong>Top Emotional Transitions:</strong><ul>`;
                            stats.top_transitions.forEach(transition => {
                                statsHtml += `<li>${transition.transition} (${transition.count} times)</li>`;
                            });
                            statsHtml += `</ul></div>`;
                        }
                        
                        learningStats.innerHTML = statsHtml;
                    } else {
                        learningStats.innerHTML = `<div class="alert alert-danger">Error: ${data.error}</div>`;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    learningStats.innerHTML = '<div class="alert alert-danger">Failed to load learning statistics.</div>';
                });
            }
            
            function resetLearning() {
                if (!confirm('Are you sure you want to reset all learning data? This cannot be undone.')) {
                    return;
                }
                
                resetLearningBtn.disabled = true;
                resetLearningBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Resetting...';
                
                fetch('/reset_learning', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    resetLearningBtn.disabled = false;
                    resetLearningBtn.innerHTML = '<i class="bi bi-trash"></i> Reset Learning';
                    
                    if (data.success) {
                        alert('Learning data has been reset successfully.');
                        loadLearningStats();
                    } else {
                        alert(`Error: ${data.error}`);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    resetLearningBtn.disabled = false;
                    resetLearningBtn.innerHTML = '<i class="bi bi-trash"></i> Reset Learning';
                    alert('Failed to reset learning data.');
                });
            }
            
            function clearChat() {
                if (!confirm('Are you sure you want to clear the chat?')) {
                    return;
                }
                
                fetch('/clear_chat', {
                    method: 'POST',
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Clear chat messages except for the first welcome message
                        const welcomeMessage = chatMessages.firstElementChild;
                        chatMessages.innerHTML = '';
                        if (welcomeMessage) {
                            chatMessages.appendChild(welcomeMessage);
                        }
                        
                        // Clear recent emotions
                        recentEmotions.innerHTML = '<p>No emotions detected yet.</p>';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Failed to clear chat history.');
                });
            }
        });
    </script>
</body>
</html>